[//]: # (This file was autogenerated using `zio-sbt-website` plugin via `sbt generateReadme` command.)
[//]: # (So please do not edit it manually. Instead, change "docs/index.md" file or sbt setting keys)
[//]: # (e.g. "readmeDocumentation" and "readmeSupport".)

# Google Cloud clients for ZIO

Collection of Google Cloud clients generated by [Google REST API code generator](https://github.com/rolang/google-rest-api-codegen) including authentication.
based on [ZIO](https://zio.dev), [Sttp (v4)](https://sttp.softwaremill.com/en/latest/) and [Jsoniter](https://github.com/plokhotnyuk/jsoniter-scala).  

Released for Scala 3 with cross-platform support.  
Supported platforms: 
 - ✅ JVM 
   - tested java versions: 17, 21
 - ✅ Native with LLVM (via [scala-native](https://scala-native.org/))
   - backed by [libuv](https://libuv.org) and [libcurl](https://curl.se/libcurl)
   - http backend uses sync curl implementation, [async backend](https://github.com/softwaremill/sttp/issues/1424) might be added at some point...
 - ❌ JavaScript (via [scala-js](https://www.scala-js.org), could be potentially added)

## Included modules / clients

- `zio-gcp-auth` Module providing authentication methods and http backends.  
More details about authentication under [Authentication](#authentication) section.

### clients
- `zio-gcp-aiplatform-v1` Client code for [Google Cloud Vertext AI API](https://cloud.google.com/vertex-ai/docs/reference/rest).
- `zio-gcp-pubsub-v1` Client code for [Google Cloud Pub/Sub API](https://cloud.google.com/pubsub/docs/reference/rest/).
- `zio-gcp-storage-v1`Client code for [Google Cloud Storage API](https://cloud.google.com/storage/docs/json_api).
- `zio-gcp-iamcredentials-v1`Client code for [Google Cloud IAM Credentials API](https://cloud.google.com/iam/docs/reference/credentials/rest/).

## Getting started
To get started with sbt, add the dependency to your project in `build.sbt`
```scala
libraryDependencies ++= Seq(
  "com.anymindgroup" %% "zio-gcp-auth" % "0.0.3",
  // add clients based on needs
  "com.anymindgroup" %% "zio-gcp-aiplatform-v1" % "0.0.3",
  "com.anymindgroup" %% "zio-gcp-pubsub-v1" % "0.0.3",
  "com.anymindgroup" %% "zio-gcp-storage-v1" % "0.0.3",
  "com.anymindgroup" %% "zio-gcp-iamcredentials-v1" % "0.0.3",
)
```

In a cross-platform project via [sbt-crossproject](https://github.com/portable-scala/sbt-crossproject) use `%%%` operator:
```scala
libraryDependencies += "com.anymindgroup" %%% "zio-gcp-auth" % "0.0.3"
// etc.
```

### Client usage examples

#### Generate content via Vertext AI API:

```scala
//> using scala 3.6.3
//> using dep com.anymindgroup::zio-gcp-auth::0.0.3
//> using dep com.anymindgroup::zio-gcp-aiplatform-v1::0.0.3

import zio.*
import com.anymindgroup.gcp.*, auth.*
import aiplatform.v1.*, aiplatform.v1.resources.*, aiplatform.v1.schemas.*
import sttp.client4.Response

object vertex_ai_generate_content extends ZIOAppDefault:
  def run = for
    authedBackend <- defaultAccessTokenBackend()
    endpoint       = Endpoint.`asia-northeast1`
    request = projects.locations.publishers.Models.generateContent(
                projectsId = "anychat-staging",
                locationsId = endpoint.location,
                publishersId = "google",
                modelsId = "gemini-1.5-flash",
                request = GoogleCloudAiplatformV1GenerateContentRequest(
                  contents = Chunk(
                    GoogleCloudAiplatformV1Content(
                      parts = Chunk(GoogleCloudAiplatformV1Part(text = Some("hello how are doing?"))),
                      role = Some("user"),
                    )
                  )
                ),
                endpointUrl = endpoint.url,
              )
    _ <- authedBackend
           .send(request)
           .flatMap:
             case Response(Right(body), _, _, _, _, _) => Console.printLine(s"Response ok: $body")
             case Response(Left(err), _, _, _, _, _)   => Console.printError(s"Failure: $err")
  yield ()
```

#### Upload file to storage bucket
```scala
//> using scala 3.6.3
//> using dep com.anymindgroup::zio-gcp-auth::0.0.3
//> using dep com.anymindgroup::zio-gcp-storage-v1::0.0.3

import zio.*, Console.{printLine, printError}
import com.anymindgroup.gcp.auth.defaultAccessTokenBackend
import com.anymindgroup.gcp.storage.v1.resources.Objects
import sttp.client4.Response, sttp.model.{Header, MediaType}
import java.nio.charset.StandardCharsets

object storage_bucket_upload extends ZIOAppDefault:
  def run =
    for
      backend   <- defaultAccessTokenBackend()
      bucket     = "my-bucket"
      objName    = "folder/my_file.txt"
      objContent = "my file content".getBytes(StandardCharsets.UTF_8)
      // insert file
      _ <- backend
             .send(
               Objects
                 .insert(bucket = bucket, name = Some(objName))
                 .headers(Header.contentType(MediaType.TextPlain), Header.contentLength(objContent.length))
                 .body(objContent)
             )
             .flatMap:
               case Response(Right(body), _, _, _, _, _) => printLine(s"Upload ok: ${body.id.getOrElse("")}")
               case Response(Left(err), _, _, _, _, _)   => ZIO.dieMessage(s"Failure on upload: $err")
      // delete file
      _ <- backend
             .send(Objects.delete(`object` = objName, bucket = bucket))
             .flatMap:
               case Response(Right(body), _, _, _, _, _) => printLine(s"Object deleted.")
               case Response(Left(err), _, _, _, _, _)   => printError(s"Failure on deleting object: $err")
    yield ()
```

## Authentication

The module `zio-gcp-auth` provides methods for authentication.  
It's primarily meant to run on a VM in Google Cloud and make use of [compute metadata](https://cloud.google.com/compute/docs/metadata/overview).

Currently supported credentials and tokens:

| Credentials | [Access token](https://cloud.google.com/docs/authentication/token-types#access) | [ID token](https://cloud.google.com/docs/authentication/token-types#id) |
| --- | --- | --- |
| [Service account](https://cloud.google.com/docs/authentication#service-accounts) (via [compute metadata](https://cloud.google.com/compute/docs/metadata/overview)) | ✅ | ✅ |
| [User credentials](https://cloud.google.com/docs/authentication/application-default-credentials#personal) | ✅ | ❌ |
| Service account (via private key) | ❌ | ❌ |

## Authentication usage examples

### Using default token provider (the token is cached and automatically refreshed)

```scala
import zio.*, zio.Console.*, com.anymindgroup.gcp.auth.*, com.anymindgroup.http.*

object AccessTokenByUser extends ZIOAppDefault:
  def run =
    (for {
      // choose the required token provider
      //
      // use TokenProvider[AccessToken] if the application doesn't require identity information
      // see https://cloud.google.com/docs/authentication/token-types#access for more information
      //
      // use TokenProvider[IdToken] if the token needs to be inspected by the application
      // see https://cloud.google.com/docs/authentication/token-types#id for more information
      //
      // use TokenProvider[Token] if it doesn't matter whether the provided token is an Access or ID token
      tokenProvider <- ZIO.service[TokenProvider[AccessToken]]
      tokenReceipt  <- tokenProvider.token
      token          = tokenReceipt.token
      _             <- printLine(s"Pass as bearer token to a Google Cloud API: ${token.token}")
      _             <- printLine(s"Received token at ${tokenReceipt.receivedAt}")
      _             <- printLine(s"Token expires in ${token.expiresIn.getSeconds()}s")
    } yield ()).provide(
      // Default token provider looks up credentials in the following order
      // 1. Credentials key file under the location set via GOOGLE_APPLICATION_CREDENTIALS environment variable
      // 2. Default applications credentials
      //    Linux, macOS: $HOME/.config/gcloud/application_default_credentials.json
      //    Windows: %APPDATA%\gcloud\application_default_credentials.json
      // 3. Attached service account via compute metadata service https://cloud.google.com/compute/docs/metadata/overview
      TokenProvider.defaultAccessTokenProviderLayer(
        // Optional parameter: whether to lookup credentials from the compute metadata service before applications credentials
        // Default: false
        lookupComputeMetadataFirst = false,
        // Optional parameter: retry Schedule on token retrieval failures.
        // Dafault: Schedule.recurs(5)
        refreshRetrySchedule = Schedule.recurs(5),
        // Optional parameter: at what stage of expiration in percent to request a new token.
        // Default: 0.9 (90%)
        // e.g. a token that expires in 3600 seconds, will be refreshed after 3240 seconds (6 mins before expiry)
        refreshAtExpirationPercent = 0.9,
      ),
      httpBackendLayer(),
    )
```

### Simple access token retrieval without caching and auto refreshing
```scala
import zio.*, zio.Console.*, com.anymindgroup.gcp.auth.*, com.anymindgroup.http.*

object SimpleTokenRetrieval extends ZIOAppDefault:
  def run = for {
    receipt <- ZIO.scoped(TokenProvider.defaultAccessTokenProvider().flatMap(_.token)).provide(httpBackendLayer())
    _       <- printLine(s"got access token: ${receipt.token.token.value.mkString} at ${receipt.receivedAt}")
  } yield ()
```

### Change credentials lookup order

```scala
import zio.*, com.anymindgroup.gcp.auth.*, com.anymindgroup.http.*

object LookupComputeMetadataFirst extends ZIOAppDefault:
  def run =
    Credentials.computeServiceAccount.flatMap {
      case Some(c) => ZIO.some(c)
      case None    => Credentials.applicationCredentials
    }.flatMap {
      case None              => ZIO.dieMessage("No credentials found")
      case Some(credentials) => ZIO.scoped(TokenProvider.accessTokenProvider(credentials))
    }.provide(httpBackendLayer())
```

### Use specific credentials

```scala
import zio.*, com.anymindgroup.gcp.auth.*, com.anymindgroup.http.*

object PassSpecificUserAccount extends ZIOAppDefault:
  def run =
    TokenProvider
      .accessTokenProvider(
        Credentials.UserAccount(
          refreshToken = "refresh_token",
          clientId = "123.apps.googleusercontent.com",
          clientSecret = Config.Secret("user_secret"),
        )
      )
      .provideSome[Scope](httpBackendLayer())
```

### Change log level

All logging is using `ZIO.log`. This allows you to override the log level
as e.g. described in this [zio logging tutorial guide](https://zio.dev/guides/tutorials/enable-logging-in-a-zio-application#overriding-log-levels).  
Example of setting the token provider log level to debug:
```scala
import zio.*, com.anymindgroup.gcp.auth.*, com.anymindgroup.http.*

object SetLogLevelToDebug extends ZIOAppDefault:
  def run =
    ZIO
      .logLevel(LogLevel.Debug)(TokenProvider.defaultAccessTokenProvider())
      .provideSome[Scope](httpBackendLayer())
```

Run examples with sbt:
```shell
sbt examples/run
```

## Documentation



## Contributing



## Code of Conduct



## Support



## License


